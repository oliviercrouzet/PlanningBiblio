{# myAccount.html.twig #}

{% extends 'base.html.twig' %}

{% block page %}
  <style>
    .password-input {
      position: absolute;
      left: 300px;
    }
    .password-error {
      color: red;
      display: none;
    }
  </style>
  <script type='text/JavaScript'>
    function save_password(password) {
      $.ajax({
        url: url('ajax/change-own-password'),
        type: "POST",
        dataType: "html",
        data: {password: password},
        success: function(){
            $("#reset-password-form").dialog( "close" );
        },
        error: function(xhr, ajaxOptions, thrownError){
          alert("Erreur lors de la modification du mot de passe");
        }
      });
    }

    $(document).ready(function(){
      $("#reset-password-form").dialog({
        autoOpen: false,
        height: 280,
        width: 580,
        modal: true,
        buttons: {
          Enregistrer: function() {
            $('#password-dont-match').hide();
            $('#password-empty').hide();
            $('#password-too-weak').hide();
            $('#password-check-error').hide();

            password = $('#new_password').val();
            confirm_password = $('#confirm_new_password').val();
            password_check = false;

            $.ajax({
                url: url('ajax/check-password'),
                type: "POST",
                dataType: "html",
                async: false,
                data: {password: password},
                success: function(result){
                    console.log(result);
                    if (result == "ok") {
                        password_check = true;
                    } else {
                        console.log("show message");
                        $('#password-too-weak').show();
                    }
                },
                error: function(xhr, ajaxOptions, thrownError){
                  $('#password-check-error').show();
                }
              });


            if (password != confirm_password) {
              $('#password-dont-match').show();
            }
            else if (password == '') {
              $('#password-empty').show();
            } else if (password_check == true) {
              save_password(password);
            }
          },
          Annuler: function() {
            $(this).dialog( "close" );
          },
        },
      });

      $('#change-password-link').on('click', function() {
        $("#reset-password-form").dialog( "open" );
      });

    });
  </script>
  <!--	Menu	-->
  <h3>Mon Compte</h3>

  <div class='ui-tabs'>
    <ul>
      {% if config('PlanningHebdo') %}
        <li><a href='#working_hours'>Mes heures de présence</a></li>
      {% endif %}
      {% if config('Conges-Enable') %}
        <li><a href='#credits'>Mes crédits</a></li>
      {% endif %}
      {% if ics %}
        <li><a href='#ics'>Calendrier ICS</a></li>
      {% endif %}
      <li><a href='#motDePasse'>Mon mot de passe</a></li>
    </ul>
    {% if config('PlanningHebdo') %}
      <!-- Working hours -->
      <div id='working_hours'>
        <div style='display: inline-block; width:300px;'>
          <h3>Heures de présence</h3>
        </div>
        {% if config('PlanningHebdo-Agents') %}
          <div style='display: inline-block; width:300px; position: absolute; right: 22px; text-align: right; margin-top:22px;'>
            <a href="{{ asset ('workinghour/add') }}?retour=/myaccount" class='ui-button'>Entrer de nouveaux horaires</a>
          </div>
        {% endif %}
    {% endif %}
     <!-- Working hours history -->
    <div id='historique'>
    <br/>
      <table id='tablePresenceMonCompte' class='CJDataTable' data-sort='[[1],[2],[3]]'>
        <thead>
          <tr>
            <th class='dataTableNoSort'>&nbsp;</th>
            <th class='dataTableDateFR'>Début</th>
            <th class='dataTableDateFR'>Fin</th>
            <th class='dataTableDateFR'>Saisie</th>
            <th>Validation</th>
            <th>Actuel</th>
            <th>Commentaires</th>
          </tr>
        </thead>
        <tbody>
          {% for elem in planning %}
            <tr>
              <td style='white-space:nowrap;'>{{ elem.remplace ? "<font style='font-size:20pt;'>&rdsh;</font>": "" }}
                <a href='/workinghour/{{ elem.id }}?retour=/myaccount'/>
                  <span class='pl-icon pl-icon-edit' title='Voir'></span>
                </a>
              </td>
              <td>{{ elem.debut }}</td>
              <td>{{ elem.fin }}</td>
              <td>{{ elem.saisie }}</td>
              <td>{{ elem.validation }}</td>
              <td>{{ elem.actuel ? "Oui" : ""}}</td>
              <td>{{ elem.commentaires }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div> <!-- Historique' -->
  </div> <!-- working_hours -->
  {% if config('Conges-Enable') %}
    <!-- Crédits -->
    <div id='credits' style='margin-left:80px;display:none;'>
      <h3>Crédits</h3>
      <table class='tableauFiches'>
        <tr>
          <td style='font-weight:bold;' colspan='2'>Congés</td>
        </tr>
        <tr>
          <td>Crédit annuel</td>
          <td style='text-align:right;'>
            {{ credits.annuel }}
          </td>
          <td style='text-align:right;'>
            {{ credits.joursAnnuel }} jours
          </td>
        </tr>
        <tr>
          <td>Crédit restant</td>
          <td style='text-align:right;'>
            {{ credits.conges }}
          </td>
          <td style='text-align:right;'>
            {{ credits.joursConges }} jours
          </td>
        </tr>
        <tr>
          <td>Reliquat</td>
          <td style='text-align:right;'>
            {{ credits.reliquat }}
          </td>
          <td style='text-align:right;'>
            {{ credits.joursReliquat}} jours
          </td>
        </tr>
        <tr>
          <td>Solde débiteur</td>
          <td style='text-align:right;'>
            {{ credits.anticipation }}</td>
            <td style='text-align:right;'>
              {{ credits.joursAnticipation }} jours
            </td>
        </tr>
        <tr>
          <td style='font-weight:bold;padding-top:20px;' colspan='2'>Récupérations</td>
        </tr>
        <tr>
          <td>Crédit</td>
          <td style='text-align:right;'>
            {{ credits.recuperation }}
          </td>
          <td style='text-align:right;'>
            {{ credits.joursRecuperation }} jours
          </td>
        </tr>
      </table>
      <p style='font-style:italic;margin:30px 0 0 10px;'>Le nombre de jours est calculé sur la base de 7 heures par jour.</p>
    </div>
  <!-- Crédits-->
  {% endif %}
    <!-- Mot de Passe -->
    <div id='motDePasse' style='margin-left:80px;display:none;'>
      {% if config('demo') %}
        <h3>Modification du mot de passe</h3>
        Vous utilisez une version de démonstration.<br/>
        Votre mot de passe ne peut pas être modifié.<br/>
      {% elseif auth_mode == "SQL" %}
       <a id="change-password-link" href="javascript:void(0)">Changer mon mot de passe</a></td>
       <div id="reset-password-form" title="Réinitialisation du mot de passe" class='noprint' style='display:none;'>
          <form>
            <div>
              <label for="new_password">Nouveau mot de passe</label>
              <input class="password-input" type='password' id="new_password" name="new_password"/>
            </div>

            <br />

            <div>
              <label for="confirm_new_password">Confirmez le nouveau mot de passe</label>
              <input class="password-input" type='password' id="confirm_new_password" name="confirm_new_password"/>
            </div>

            <br />

            <div class="password-error" id="password-dont-match">
                Les mots de passe ne sont pas identiques.
            </div>
            <div class="password-error" id="password-empty">
                Le mot de passe ne peut pas être vide.
            </div>
            <div class="password-error" id="password-too-weak">
                Le mot de passe est trop faible. Le mot de passe doit faire au minimum 8 caractères, et contenir au moins une minuscule, une majuscule, un chiffre et un caractère spécial.
                Les caractères spéciaux sont les suivants: !"#$%&'()*+,-./:;<=>?@[\]^_`{|}~
            </div>
            <div class="password-error" id="password-check-error">
                Impossible de vérifier la robustesse du mot de passe. Veuillez contacter votre administrateur.
            </div>


          </form>
        </div>

      {% else %}
        <h3>Modification du mot de passe</h3>
        Vous utilisez un système d'authentification centralisé.<br/>
        Votre mot de passe ne peut pas être modifié à partir du planning.<br/>
      {% endif %}
    </div> <!-- motDePasse -->
    <!-- Calendrier ICS -->
    <div id='ics' style='margin-left:80px;display:none;'>
      <h3>URL de votre calendrier ICS</h3>
      <p>
        <span id='url-ics'><a href='{{ config('URL') }}{{ ics | raw }}'>{{ config('URL') }}{{ ics | raw }}</a></span>
        {% if config('ICS-Code') %}
        <br/><a href="javascript:resetICSURL({{ login.id }}, '{{ CSRFSession }}' );"> Réinitialiser l'URL</a>
        {% endif %}
      </p>
    </div> <!-- Calendrier ICS -->
  </div> <!-- ui-tabs -->
{% endblock %}
